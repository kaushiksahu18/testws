<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WS1 - io</title>
  </head>
  <body>
    <div style="display: flex; gap: 10px">
      <div>
        <form id="form" action="#">
          <input id="input" type="text" placeholder="message" />
          <button type="submit">Send</button>
        </form>
        <br /><br /><br />
        <ul id="messages"></ul>
      </div>
      <div id="room-main">
        <form id="m-rform" action="#">
          Create Room: <input id="nroomid" type="text" placeholder="create-roomid" />
          Join: <input id="roomid" type="text" placeholder="roomid" />
          <button type="submit">Create/Join</button>
        </form>
        <div>
          <form style="opacity: 0;" id="rform" action="#">
            <input id="rinput" type="text" placeholder="message" />
            <button type="submit">Send</button>
          </form>
          <br /><br /><br />
          <ul id="rmessages"></ul>
        </div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const url = "https://74ca1a50-0c0d-44f1-8fdf-60624ff32488-00-3mlmx8j18fxsi.pike.replit.dev";
      let currentRoomId = "";
      const socket = io(url);

      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit("chat message", input.value);
          input.value = "";
        }
      });

      socket.on("chat message", (msg) => {
        const item = document.createElement("li");
        item.textContent = msg;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      });

      const mrform = document.getElementById("m-rform");
      const rform = document.getElementById("rform");
      const nroomid = document.getElementById("nroomid");
      const roomid = document.getElementById("roomid");

      mrform.addEventListener("submit", (e) => {
        e.preventDefault();
        const val = nroomid.value || roomid.value;
        if (val) {
          fetch(`${url}/roomid`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ roomid: val }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Success:", data);
              currentRoomId = val;
              socket.emit("join room", currentRoomId); // Join the room
              rform.style.opacity = "100";
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      });

      const rinput = document.getElementById("rinput");
      const rmessages = document.getElementById("rmessages");

      rform.addEventListener("submit", (e) => {
        e.preventDefault();
        if (rinput.value) {
          socket.emit("chat message", { roomid: currentRoomId, msg: rinput.value });
          rinput.value = "";
        }
      });

      socket.on("chat message", (msg) => {
        if (msg.roomid === currentRoomId) {
          const item = document.createElement("li");
          item.textContent = msg.msg;
          rmessages.appendChild(item);
          window.scrollTo(0, document.body.scrollHeight);
        }
      });
    </script>
  </body>
</html>
